<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>DoctorAI</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

:root {
  --bg: #060a10;
  --card: #0c1220;
  --border: #162030;
  --accent: #00d4ff;
  --accent2: #0066ff;
  --green: #00ff88;
  --text: #dce8f5;
  --muted: #3a5068;
  --danger: #ff4466;
}

html, body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100%;
  height: 100dvh;
  overflow: hidden;
}

body {
  display: flex;
  flex-direction: column;
}

/* Scanline overlay */
body::before {
  content:'';
  position:fixed;
  inset:0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,212,255,0.01) 2px, rgba(0,212,255,0.01) 4px);
  pointer-events:none;
  z-index:100;
}

.glow-bg {
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:
    radial-gradient(ellipse 60% 50% at 30% 20%, rgba(0,102,255,0.08) 0%, transparent 70%),
    radial-gradient(ellipse 50% 40% at 70% 80%, rgba(0,212,255,0.06) 0%, transparent 70%);
  pointer-events:none;
  z-index:0;
}

/* ‚îÄ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ‚îÄ */
.topbar {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:rgba(6,10,16,0.95);
  backdrop-filter:blur(16px);
  -webkit-backdrop-filter:blur(16px);
  position:relative;
  z-index:10;
  flex-shrink:0;
}

.logo {
  font-family:'Syne',sans-serif;
  font-size:17px;
  font-weight:800;
  letter-spacing:-0.5px;
  display:flex;
  align-items:center;
  gap:6px;
}
.logo-dot { color:var(--accent); }

.call-info {
  display:flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:var(--muted);
}

.rec-dot {
  width:7px; height:7px;
  background:var(--danger);
  border-radius:50%;
  animation: blink 1.2s ease-in-out infinite;
}
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

.timer { font-family:monospace; color:var(--text); font-size:12px; }

/* ‚îÄ‚îÄ‚îÄ LAYOUT: DESKTOP vs MOBILE ‚îÄ‚îÄ‚îÄ */
.layout {
  flex:1;
  display:flex;
  overflow:hidden;
  position:relative;
  z-index:1;
  min-height:0;
}

/* Desktop: side-by-side */
@media (min-width: 640px) {
  .layout { flex-direction: row; }

  .video-area {
    flex:1;
    display:flex;
    flex-direction:column;
    padding:16px;
  }

  .convo-panel {
    width:300px;
    flex-shrink:0;
    border-left:1px solid var(--border);
    display:flex;
    flex-direction:column;
    background:rgba(6,10,16,0.6);
    backdrop-filter:blur(8px);
  }
}

/* Mobile: stacked ‚Äî video top, convo bottom */
@media (max-width: 639px) {
  .layout { flex-direction: column; }

  .video-area {
    /* 68% for doctor card ‚Äî more breathing room */
    flex: 0 0 68%;
    display:flex;
    flex-direction:column;
    padding:10px 10px 0;
    min-height:0;
  }

  .convo-panel {
    flex:1;
    border-top:1px solid var(--border);
    display:flex;
    flex-direction:column;
    background:rgba(6,10,16,0.85);
    min-height:0;
  }
}

/* ‚îÄ‚îÄ‚îÄ DOCTOR CARD ‚îÄ‚îÄ‚îÄ */
.doctor-card {
  flex:1;
  border-radius:18px;
  background:var(--card);
  border:1px solid var(--border);
  position:relative;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:0;
}

.doctor-card::before {
  content:'';
  position:absolute;
  inset:0;
  background:
    radial-gradient(ellipse 80% 60% at 50% 40%, rgba(0,102,255,0.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 80% at 20% 80%, rgba(0,212,255,0.06) 0%, transparent 50%);
  animation: meshMove 8s ease-in-out infinite alternate;
}
@keyframes meshMove {
  from { opacity:0.6; transform:scale(1); }
  to { opacity:1; transform:scale(1.05); }
}

.doctor-card::after {
  content:'';
  position:absolute;
  inset:0;
  background-image:
    linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
  background-size:40px 40px;
}

.doctor-figure {
  position:relative;
  z-index:2;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:12px;
  transform:translateY(-10%);
}
@media (max-width: 639px) {
  .doctor-figure {
    transform:translateY(-22%);
  }
}

/* Rings */
.avatar-wrap { position:relative; }

.avatar-rings {
  position:absolute;
  inset:-20px;
  border-radius:50%;
}

.ring {
  position:absolute;
  border-radius:50%;
  border:1px solid rgba(0,212,255,0.15);
  animation:ringPulse 3s ease-in-out infinite;
}
.ring:nth-child(1) { inset:0; animation-delay:0s; }
.ring:nth-child(2) { inset:-12px; animation-delay:0.5s; }
.ring:nth-child(3) { inset:-24px; animation-delay:1s; }
.ring:nth-child(4) { inset:-36px; animation-delay:1.5s; }

@keyframes ringPulse {
  0%,100% { opacity:0.3; transform:scale(1); }
  50% { opacity:0.8; transform:scale(1.02); }
}
.ring.active { border-color:rgba(0,212,255,0.4); animation:ringPulseActive 0.6s ease-in-out infinite; }
@keyframes ringPulseActive {
  0%,100% { opacity:0.6; transform:scale(1); }
  50% { opacity:1; transform:scale(1.04); }
}

/* Doctor SVG ‚Äî smaller on mobile */
.doctor-svg {
  width:110px;
  height:110px;
  position:relative;
  z-index:2;
}
@media (min-width: 640px) {
  .doctor-svg { width:140px; height:140px; }
}

.doctor-circle-bg { fill: rgba(0,102,255,0.15); stroke: rgba(0,212,255,0.3); stroke-width:1.5; }
.doctor-body { fill: rgba(0,212,255,0.12); stroke:rgba(0,212,255,0.4); stroke-width:1.5; }
.doctor-head { fill: rgba(0,212,255,0.2); stroke:rgba(0,212,255,0.5); stroke-width:1.5; }
.doctor-cross { fill:rgba(0,212,255,0.8); }

.doctor-name-tag {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,212,255,0.1);
  border:1px solid rgba(0,212,255,0.3);
  border-radius:100px;
  padding:3px 12px;
  font-size:10px;
  color:var(--accent);
  font-weight:500;
  letter-spacing:1px;
  white-space:nowrap;
  z-index:10;
}

/* Speaking wave */
.doctor-wave {
  display:flex;
  align-items:center;
  gap:3px;
  height:24px;
}
.dwave-bar {
  width:3px;
  background:linear-gradient(to top, var(--accent2), var(--accent));
  border-radius:2px;
  height:4px;
  opacity:0.3;
  transition:height 0.1s, opacity 0.1s;
}
.dwave-bar.active { opacity:1; }
.dwave-bar.active:nth-child(7n+1) { animation:dw1 0.5s ease-in-out infinite; }
.dwave-bar.active:nth-child(7n+2) { animation:dw2 0.7s ease-in-out infinite 0.1s; }
.dwave-bar.active:nth-child(7n+3) { animation:dw3 0.4s ease-in-out infinite 0.05s; }
.dwave-bar.active:nth-child(7n+4) { animation:dw4 0.6s ease-in-out infinite 0.15s; }
.dwave-bar.active:nth-child(7n+5) { animation:dw5 0.8s ease-in-out infinite 0.2s; }
.dwave-bar.active:nth-child(7n+6) { animation:dw1 0.5s ease-in-out infinite 0.3s; }
.dwave-bar.active:nth-child(7n+7) { animation:dw3 0.6s ease-in-out infinite 0.1s; }
@keyframes dw1 { 0%,100%{height:4px} 50%{height:22px} }
@keyframes dw2 { 0%,100%{height:6px} 50%{height:28px} }
@keyframes dw3 { 0%,100%{height:3px} 50%{height:18px} }
@keyframes dw4 { 0%,100%{height:8px} 50%{height:30px} }
@keyframes dw5 { 0%,100%{height:5px} 50%{height:14px} }

/* Caption */
.caption-box {
  position:absolute;
  bottom:145px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(6,10,16,0.88);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px 16px;
  max-width:85%;
  text-align:center;
  font-size:13px;
  line-height:1.5;
  color:var(--text);
  z-index:10;
  transition:opacity 0.3s;
  min-height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
}
@media (max-width: 639px) {
  .caption-box { bottom:108px; font-size:11px; padding:6px 12px; max-width:80%; min-height:34px; }
}
.caption-box.hidden { opacity:0; pointer-events:none; }

/* User PiP */
.user-pip {
  position:absolute;
  bottom:12px;
  right:12px;
  width:90px;
  height:70px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  z-index:10;
}
@media (min-width: 640px) {
  .user-pip { width:120px; height:90px; bottom:16px; right:16px; }
}

.user-pip-avatar {
  width:30px; height:30px;
  border-radius:50%;
  background:linear-gradient(135deg, rgba(0,102,255,0.3), rgba(0,212,255,0.1));
  border:1px solid rgba(0,212,255,0.2);
  display:flex; align-items:center; justify-content:center;
  font-size:15px;
}
@media (min-width: 640px) {
  .user-pip-avatar { width:36px; height:36px; font-size:18px; }
}

.user-pip-label { font-size:9px; color:var(--muted); letter-spacing:0.5px; }

.user-pip-wave { display:flex; gap:2px; align-items:center; height:12px; }
.upwave { width:2px; height:3px; background:var(--accent); border-radius:1px; opacity:0.3; }
.upwave.active:nth-child(odd) { animation:dw3 0.5s ease-in-out infinite; opacity:1; }
.upwave.active:nth-child(even) { animation:dw1 0.7s ease-in-out infinite 0.1s; opacity:1; }

/* ‚îÄ‚îÄ‚îÄ INLINE CONTROLS ‚îÄ‚îÄ‚îÄ */
.inline-controls {
  position:absolute;
  bottom:0; left:0; right:0;
  padding:16px 14px 14px;
  display:flex;
  flex-direction:column;
  gap:10px;
  background:linear-gradient(to top, rgba(6,10,16,0.98) 0%, rgba(6,10,16,0.7) 60%, transparent 100%);
  z-index:10;
  border-radius:0 0 18px 18px;
}
@media (min-width: 640px) {
  .inline-controls { padding:24px 20px 24px; gap:16px; }
}
@media (max-width: 639px) {
  .inline-controls { padding:10px 12px 10px; gap:7px; }
}

/* Language pills */
.lang-scroll-wrap {
  position:relative;
}
/* Fade-out gradient on right to hint at more content */
.lang-scroll-wrap::after {
  content:'';
  position:absolute;
  right:0; top:0; bottom:0;
  width:36px;
  background:linear-gradient(to right, transparent, rgba(6,10,16,0.95));
  pointer-events:none;
  border-radius:0 4px 4px 0;
}

.lang-scroll {
  display:flex;
  gap:6px;
  overflow-x:auto;
  scrollbar-width:none;
  justify-content:flex-start;
  padding-bottom:2px;
  padding-right:30px; /* leave room so last pill isn't hidden behind fade */
}
.lang-scroll::-webkit-scrollbar { display:none; }

.lang-pill {
  flex-shrink:0;
  padding:5px 13px;
  border-radius:100px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  font-family:'Outfit',sans-serif;
  font-size:12px;
  cursor:pointer;
  transition:all 0.2s;
  white-space:nowrap;
  /* Bigger tap target on mobile */
  min-height:34px;
  display:flex;
  align-items:center;
}
.lang-pill:hover { border-color:var(--accent); color:var(--text); }
.lang-pill.active {
  background:linear-gradient(135deg,var(--accent2),var(--accent));
  border-color:transparent;
  color:white;
  font-weight:600;
}

/* Bottom buttons */
.bottom-btns {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:20px;
}

.mic-wrap { display:flex; flex-direction:column; align-items:center; gap:3px; flex-shrink:0; }

.mic-btn {
  width:56px; height:56px;
  border-radius:50%;
  border:none;
  background:linear-gradient(135deg, var(--accent2), var(--accent));
  cursor:pointer;
  font-size:22px;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.2s;
  box-shadow:0 0 20px rgba(0,212,255,0.2);
  touch-action:manipulation;
  user-select:none;
  -webkit-user-select:none;
}
@media (min-width: 640px) {
  .mic-btn { width:60px; height:60px; font-size:24px; }
}
.mic-btn:active:not(.disabled) { transform:scale(0.95); }
.mic-btn.recording { background:linear-gradient(135deg,var(--danger),#ff6600); animation:micPulse 1.2s ease-in-out infinite; }
.mic-btn.disabled { opacity:0.35; cursor:not-allowed; }

@keyframes micPulse {
  0%{box-shadow:0 0 0 0 rgba(255,68,102,0.5)}
  70%{box-shadow:0 0 0 18px rgba(255,68,102,0)}
  100%{box-shadow:0 0 0 0 rgba(255,68,102,0)}
}

.mic-hint { font-size:10px; color:var(--muted); letter-spacing:0.5px; text-transform:uppercase; }

.end-btn {
  width:56px; height:56px;
  border-radius:50%;
  border:1px solid rgba(255,68,102,0.3);
  background:rgba(255,68,102,0.15);
  color:var(--danger);
  font-size:22px;
  cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all 0.2s;
  flex-shrink:0;
  touch-action:manipulation;
  user-select:none;
  -webkit-user-select:none;
}
@media (min-width: 640px) {
  .end-btn { width:60px; height:60px; font-size:24px; }
}
.end-btn:active { background:rgba(255,68,102,0.25); }

.end-wrap { display:flex; flex-direction:column; align-items:center; gap:3px; }

/* ‚îÄ‚îÄ‚îÄ CONVERSATION PANEL ‚îÄ‚îÄ‚îÄ */
.convo-header {
  padding:10px 14px;
  border-bottom:1px solid var(--border);
  font-size:10px;
  color:var(--muted);
  letter-spacing:1px;
  text-transform:uppercase;
  font-weight:500;
  flex-shrink:0;
}

.convo-messages {
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  scrollbar-width:thin;
  scrollbar-color:var(--border) transparent;
  -webkit-overflow-scrolling:touch;
  overscroll-behavior:contain;
}
.convo-messages::-webkit-scrollbar { width:3px; }
.convo-messages::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }

/* Mobile: slightly denser input area below messages */
.convo-input-area {
  display:none; /* hidden on desktop ‚Äî controls are in video area */
}

.cmsg {
  display:flex;
  flex-direction:column;
  gap:2px;
  animation:fadeUp 0.3s ease;
}
@keyframes fadeUp {
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:translateY(0)}
}
.cmsg.user { align-items:flex-end; }

.cmsg-label { font-size:9px; color:var(--muted); letter-spacing:0.5px; text-transform:uppercase; }

.cmsg-bubble {
  padding:7px 11px;
  border-radius:12px;
  font-size:12px;
  line-height:1.5;
  max-width:88%;
}
@media (min-width: 640px) {
  .cmsg-bubble { font-size:12.5px; max-width:240px; padding:8px 12px; }
}

.cmsg.doctor .cmsg-bubble {
  background:rgba(0,212,255,0.07);
  border:1px solid rgba(0,212,255,0.15);
  border-top-left-radius:3px;
  color:var(--text);
}
.cmsg.user .cmsg-bubble {
  background:rgba(0,102,255,0.2);
  border:1px solid rgba(0,102,255,0.3);
  border-top-right-radius:3px;
  color:var(--text);
}

.thinking-dots {
  display:flex;
  gap:4px;
  padding:7px 11px;
  background:rgba(0,212,255,0.07);
  border:1px solid rgba(0,212,255,0.15);
  border-radius:12px;
  border-top-left-radius:3px;
  width:fit-content;
}
.thinking-dots span {
  width:5px; height:5px;
  background:var(--muted);
  border-radius:50%;
  animation:think 1.2s ease-in-out infinite;
}
.thinking-dots span:nth-child(2){animation-delay:0.2s}
.thinking-dots span:nth-child(3){animation-delay:0.4s}
@keyframes think{0%,100%{opacity:0.3;transform:translateY(0)}50%{opacity:1;transform:translateY(-3px)}}

/* ‚îÄ‚îÄ‚îÄ MOBILE: show convo-empty as smaller placeholder ‚îÄ‚îÄ‚îÄ */
.convo-empty {
  text-align:center;
  color:var(--muted);
  font-size:12px;
  margin-top:20px;
  line-height:1.8;
}
</style>
</head>
<body>
<div class="glow-bg"></div>

<!-- Top bar -->
<div class="topbar">
  <div class="logo">Doctor<span class="logo-dot">AI</span></div>
  <div class="call-info">
    <div class="rec-dot" id="recDot" style="display:none"></div>
    <span class="timer" id="timer" style="display:none">00:00</span>
    <span id="callStatus" style="font-size:11px;color:var(--muted)">Select a language</span>
  </div>
  <div style="width:60px"></div>
</div>

<!-- Main layout -->
<div class="layout">

  <!-- Video area -->
  <div class="video-area">
    <div class="doctor-card">

      <!-- Doctor figure -->
      <div class="doctor-figure">
        <div class="avatar-wrap">
          <div class="avatar-rings">
            <div class="ring" id="r1"></div>
            <div class="ring" id="r2"></div>
            <div class="ring" id="r3"></div>
            <div class="ring" id="r4"></div>
          </div>
          <svg class="doctor-svg" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
            <circle cx="70" cy="70" r="68" class="doctor-circle-bg"/>
            <ellipse cx="70" cy="105" rx="30" ry="22" class="doctor-body"/>
            <path d="M55 88 L70 100 L85 88 L80 82 L70 90 L60 82 Z" class="doctor-body"/>
            <circle cx="70" cy="58" r="22" class="doctor-head"/>
            <path d="M58 80 Q52 90 56 96 Q60 102 66 100" fill="none" stroke="rgba(0,212,255,0.6)" stroke-width="2" stroke-linecap="round"/>
            <circle cx="66" cy="101" r="3" fill="rgba(0,212,255,0.6)"/>
            <rect x="67" y="92" width="6" height="14" rx="2" class="doctor-cross"/>
            <rect x="63" y="96" width="14" height="6" rx="2" class="doctor-cross"/>
            <ellipse cx="63" cy="57" rx="3" ry="3.5" fill="rgba(0,212,255,0.7)"/>
            <ellipse cx="77" cy="57" rx="3" ry="3.5" fill="rgba(0,212,255,0.7)"/>
            <path d="M63 66 Q70 72 77 66" fill="none" stroke="rgba(0,212,255,0.5)" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="doctor-wave" id="doctorWave"></div>
      </div>

      <div class="caption-box hidden" id="captionBox"></div>
      <div class="doctor-name-tag">DoctorAI ‚Ä¢ ONLINE</div>

      <!-- Controls inside card -->
      <div class="inline-controls">
        <div class="lang-scroll-wrap">
          <div class="lang-scroll" id="langScroll"></div>
        </div>
        <div class="bottom-btns">
          <div class="mic-wrap">
            <button class="mic-btn disabled" id="micBtn" onclick="toggleRecording()">üéôÔ∏è</button>
            <div class="mic-hint" id="micHint">‚Äî</div>
          </div>
          <div class="end-wrap">
            <button class="end-btn" onclick="endCall()" title="End call">üìµ</button>
            <div class="mic-hint">End</div>
          </div>
        </div>
      </div>

      <!-- User PiP -->
      <div class="user-pip">
        <div class="user-pip-avatar">üßë</div>
        <div class="user-pip-wave" id="userPipWave"></div>
        <div class="user-pip-label">You</div>
      </div>

    </div>
  </div>

  <!-- Conversation panel -->
  <div class="convo-panel">
    <div class="convo-header">Conversation</div>
    <div class="convo-messages" id="convoMessages">
      <div class="convo-empty">
        Select a language<br/>to begin your consultation
      </div>
    </div>
  </div>

</div>

<script>
const LANGUAGES = [
  {name:"Hindi",code:"hi-IN"},{name:"Telugu",code:"te-IN"},{name:"Tamil",code:"ta-IN"},
  {name:"Marathi",code:"mr-IN"},{name:"Bengali",code:"bn-IN"},{name:"Kannada",code:"kn-IN"},
  {name:"Gujarati",code:"gu-IN"},{name:"Malayalam",code:"ml-IN"},{name:"English",code:"en-IN"},
];

let selectedLang=null, isRecording=false, mediaRecorder=null, audioChunks=[];
let state="idle", timerInterval=null, seconds=0;
let silenceTimer=null, maxTimer=null, audioCtx=null, analyser=null;
// Abort controller + session token to kill stale language switches
let langAbortController=null, currentSession=0;
let currentAudio=null; // track playing audio so we can stop it

// Build language pills
const langScroll = document.getElementById("langScroll");
LANGUAGES.forEach(lang => {
  const btn = document.createElement("button");
  btn.className = "lang-pill";
  btn.textContent = lang.name;
  btn.onclick = () => selectLanguage(lang, btn);
  langScroll.appendChild(btn);
});

// Build wave bars
const doctorWave = document.getElementById("doctorWave");
for(let i=0;i<20;i++){ const b=document.createElement("div"); b.className="dwave-bar"; doctorWave.appendChild(b); }

const userPipWave = document.getElementById("userPipWave");
for(let i=0;i<8;i++){ const b=document.createElement("div"); b.className="upwave"; userPipWave.appendChild(b); }

function setDoctorSpeaking(on) {
  document.querySelectorAll(".dwave-bar").forEach(b=>b.className="dwave-bar"+(on?" active":""));
  document.querySelectorAll(".ring").forEach(r=>r.className="ring"+(on?" active":""));
}
function setUserSpeaking(on) {
  document.querySelectorAll(".upwave").forEach(b=>b.className="upwave"+(on?" active":""));
}
function showCaption(text, hidden=false) {
  const box=document.getElementById("captionBox");
  box.textContent=text;
  box.className="caption-box"+(hidden?" hidden":"");
}
function startTimer() {
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  const startTime = Date.now();
  document.getElementById("recDot").style.display="block";
  document.getElementById("timer").style.display="inline";
  timerInterval=setInterval(()=>{
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const m=String(Math.floor(elapsed/60)).padStart(2,"0");
    const s=String(elapsed%60).padStart(2,"0");
    document.getElementById("timer").textContent=`${m}:${s}`;
  },1000);
}
function addConvoMsg(role,text) {
  const c=document.getElementById("convoMessages");
  const p=c.querySelector(".convo-empty"); if(p) p.remove();
  const t=document.getElementById("thinkingMsg"); if(t) t.remove();
  const msg=document.createElement("div");
  msg.className=`cmsg ${role}`;
  msg.innerHTML=`<div class="cmsg-label">${role==="doctor"?"DoctorAI":"You"}</div><div class="cmsg-bubble">${text}</div>`;
  c.appendChild(msg);
  c.scrollTop=c.scrollHeight;
}
function addThinking() {
  const c=document.getElementById("convoMessages");
  const msg=document.createElement("div");
  msg.className="cmsg doctor"; msg.id="thinkingMsg";
  msg.innerHTML=`<div class="cmsg-label">DoctorAI</div><div class="thinking-dots"><span></span><span></span><span></span></div>`;
  c.appendChild(msg); c.scrollTop=c.scrollHeight;
}
async function playAudio(b64, session) {
  if(!b64) return;
  // Bail if a newer language session has started
  if(session !== undefined && session !== currentSession) return;
  setDoctorSpeaking(true);
  const audio=new Audio("data:audio/wav;base64,"+b64);
  currentAudio=audio;
  await new Promise(resolve=>{
    audio.onended=resolve;
    audio.onerror=resolve;
    audio.play().catch(resolve);
  });
  currentAudio=null;
  // Only clean up if still our session
  if(session === undefined || session === currentSession) {
    setDoctorSpeaking(false);
    showCaption("",true);
  }
}

function abortCurrentSession() {
  // Abort any in-flight fetch
  if(langAbortController) { langAbortController.abort(); langAbortController=null; }
  // Stop any playing audio immediately
  if(currentAudio) { currentAudio.pause(); currentAudio.src=""; currentAudio=null; }
  // Stop recording if active
  if(isRecording) {
    isRecording=false;
    clearInterval(silenceTimer); silenceTimer=null;
    clearTimeout(maxTimer); maxTimer=null;
    if(audioCtx){ audioCtx.close(); audioCtx=null; }
    try { mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop()); } catch(e){}
    setUserSpeaking(false);
  }
  // Stop timer
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  setDoctorSpeaking(false);
  showCaption("",true);
  state="idle";
  // Bump session so any stale async callbacks know to bail
  currentSession++;
}

async function selectLanguage(lang, btn) {
  // Kill everything in progress
  abortCurrentSession();
  const mySession = currentSession;

  document.querySelectorAll(".lang-pill").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  selectedLang=lang;

  document.getElementById("micBtn").classList.add("disabled");
  document.getElementById("micHint").textContent="Connecting...";
  document.getElementById("callStatus").textContent="Connecting...";
  document.getElementById("callStatus").style.color="var(--accent)";

  // Clear conversation
  const c=document.getElementById("convoMessages");
  c.innerHTML='';
  addThinking();

  langAbortController = new AbortController();
  let data;
  try {
    const res=await fetch("/set_language",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({lang_code:lang.code}),
      signal:langAbortController.signal
    });
    data=await res.json();
  } catch(e) {
    // Aborted ‚Äî another language was selected, just stop here
    return;
  }
  langAbortController=null;

  // Bail if user already switched to another language
  if(mySession !== currentSession) return;

  addConvoMsg("doctor",data.text);
  showCaption(data.text);
  await playAudio(data.audio, mySession);

  if(mySession !== currentSession) return;

  document.getElementById("callStatus").textContent=`${lang.name} ‚Ä¢ Connected`;
  document.getElementById("callStatus").style.color="var(--green)";
  document.getElementById("micBtn").classList.remove("disabled");
  document.getElementById("micHint").textContent="Tap to speak";
  startTimer();
}

function stopRecording() {
  if(!isRecording) return;
  isRecording=false;
  state="thinking";
  clearInterval(silenceTimer); silenceTimer=null;
  clearTimeout(maxTimer); maxTimer=null;
  if(audioCtx){ audioCtx.close(); audioCtx=null; }
  mediaRecorder.stop();
  mediaRecorder.stream.getTracks().forEach(t=>t.stop());
  setUserSpeaking(false);
  document.getElementById("micBtn").classList.remove("recording");
  document.getElementById("micBtn").classList.add("disabled");
  document.getElementById("micBtn").textContent="üéôÔ∏è";
  document.getElementById("micHint").textContent="Processing...";
  showCaption("Processing...");
}

async function processAudio() {
  const blob=new Blob(audioChunks,{type:"audio/wav"});
  const form=new FormData();
  form.append("audio",blob,"audio.wav");
  const sttRes=await fetch("/transcribe",{method:"POST",body:form});
  const sttData=await sttRes.json();
  const transcript=sttData.transcript;
  if(!transcript){
    showCaption("Didn't catch that, try again");
    document.getElementById("micBtn").classList.remove("disabled");
    document.getElementById("micHint").textContent="Tap to speak";
    state="idle"; return;
  }
  addConvoMsg("user",transcript);
  addThinking();
  showCaption("DoctorAI is thinking...");
  const chatRes=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:transcript})});
  const chatData=await chatRes.json();
  addConvoMsg("doctor",chatData.text);
  showCaption(chatData.text);
  await playAudio(chatData.audio);
  document.getElementById("micBtn").classList.remove("disabled");
  document.getElementById("micHint").textContent="Tap to speak";
  state="idle";
}

async function toggleRecording() {
  if(!selectedLang||state==="thinking"||state==="speaking") return;

  if(!isRecording) {
    let stream;
    try {
      stream=await navigator.mediaDevices.getUserMedia({audio:true});
    } catch(e) {
      showCaption("Microphone access denied");
      return;
    }

    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=512;
    audioCtx.createMediaStreamSource(stream).connect(analyser);
    const data=new Uint8Array(analyser.frequencyBinCount);
    let lastSound=Date.now();

    silenceTimer=setInterval(()=>{
      analyser.getByteTimeDomainData(data);
      let sum=0;
      for(let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
      const rms=Math.sqrt(sum/data.length)*100;
      if(rms>8) lastSound=Date.now();
      else if(Date.now()-lastSound>2500) stopRecording();
    },150);

    maxTimer=setTimeout(()=>stopRecording(),10000);

    // Prefer opus if available (better on mobile), fallback to wav
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm')
      ? 'audio/webm'
      : 'audio/wav';

    mediaRecorder=new MediaRecorder(stream, {mimeType});
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>processAudio();
    mediaRecorder.start();
    isRecording=true; state="recording";
    setUserSpeaking(true);
    document.getElementById("micBtn").classList.add("recording");
    document.getElementById("micBtn").textContent="‚èπÔ∏è";
    document.getElementById("micHint").textContent="Tap to stop";
    showCaption("Listening...");
  } else {
    stopRecording();
  }
}

function endCall() {
  abortCurrentSession();
  document.getElementById("recDot").style.display="none";
  document.getElementById("timer").style.display="none";
  document.getElementById("callStatus").textContent="Call ended";
  document.getElementById("callStatus").style.color="var(--muted)";
  document.getElementById("micBtn").classList.add("disabled");
  document.getElementById("micHint").textContent="‚Äî";
  selectedLang=null;
  document.querySelectorAll(".lang-pill").forEach(b=>b.classList.remove("active"));
}


</script>
</body>
</html>